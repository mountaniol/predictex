# Исправление: Предотвращение бесконечного цикла запросов к AI

## Проблема
При выборе опции "Other" и вводе текста в дополнительное текстовое поле происходил бесконечный цикл запросов к AI. Каждый введенный символ или событие blur триггерило новую оценку, которая в свою очередь вызывала обновление состояния и новые запросы.

## Корневые причины
1. **Отсутствие защиты от повторных вызовов** - handleAnswerBlur вызывался при каждом blur событии без проверки
2. **Отсутствие проверки изменений** - оценка запускалась даже если ответ не изменился
3. **Частые blur события** - каждое изменение текста могло вызывать blur/focus циклы
4. **Отсутствие debouncing** - немедленная реакция на каждое событие

## Реализованные исправления

### 1. Отслеживание текущих оценок (QuestionSection.js)
```javascript
const evaluationInProgress = useRef({});  // Предотвращает параллельные оценки
const lastEvaluatedAnswers = useRef({});  // Отслеживает последние оцененные ответы
```

### 2. Защита в handleAnswerBlur (QuestionSection.js)
- Проверка, не выполняется ли уже оценка для вопроса
- Сравнение текущего ответа с последним оцененным
- Пропуск оценки если ответ не изменился

### 3. Debouncing для текстовых полей "Other" (AnswerInput.js)
```javascript
const debouncedOnBlur = useCallback((id) => {
  if (debounceTimerRef.current) {
    clearTimeout(debounceTimerRef.current);
  }
  debounceTimerRef.current = setTimeout(() => {
    onBlur(id);
  }, 500); // Ждем 500мс после остановки ввода
}, [onBlur]);
```

### 4. Очистка флагов после завершения оценки
В handleSubmitAndResolveDependencies добавлена очистка флагов evaluationInProgress после завершения оценки.

## Механизм защиты

1. **При вводе текста в поле "Other":**
   - onChange обновляет значение в state
   - onBlur вызывается с задержкой (debounced)
   
2. **При обработке blur события:**
   - Проверяется, не идет ли уже оценка
   - Сравнивается текущий ответ с последним оцененным
   - Если ответ изменился и нет активной оценки - запускается новая

3. **После завершения оценки:**
   - Очищается флаг evaluationInProgress
   - Сохраняется последний оцененный ответ для сравнения

## Результат

✅ **Устранен бесконечный цикл запросов**
- При вводе текста в поле "Other" запросы не дублируются
- Оценка происходит только после завершения ввода (через 500мс)
- Повторная оценка не происходит для неизмененных ответов

✅ **Улучшена производительность**
- Снижена нагрузка на API
- Уменьшено количество ненужных запросов
- Более плавная работа интерфейса

## Тестирование

Создан тест `test_no_infinite_loop.py` который проверяет:
- Блокировку параллельных оценок
- Предотвращение повторной оценки неизмененных ответов
- Работу debouncing механизма
- Корректную обработку последовательных изменений